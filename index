<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Survei Kepuasan UKS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Nunito', sans-serif;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .pulse-icon {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .likert-option {
      transition: all 0.3s ease;
    }
    .likert-option:hover {
      transform: translateY(-2px);
    }
    .likert-option.selected {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .progress-bar {
      transition: width 0.5s ease;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto" style="background: linear-gradient(135deg, #e8f5e9 0%, #e3f2fd 50%, #f1f8e9 100%);"><!-- Page 1: Home -->
   <div id="page-home" class="min-h-full flex flex-col items-center justify-start p-6 fade-in" style="padding-top: 2rem;">
    <div class="max-w-lg w-full"><!-- Health Icon -->
     <div class="mb-6 pulse-icon flex justify-center">
      <svg class="w-24 h-24" viewbox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="45" fill="#4CAF50" opacity="0.2" /> <path d="M50 20C50 20 30 35 30 50C30 65 40 75 50 80C60 75 70 65 70 50C70 35 50 20 50 20Z" fill="#4CAF50" /> <rect x="45" y="35" width="10" height="30" rx="2" fill="white" /> <rect x="35" y="45" width="30" height="10" rx="2" fill="white" />
      </svg>
     </div>
     <h1 id="title-text" class="text-2xl md:text-3xl font-extrabold mb-2 text-center" style="color: #2e7d32;">Survei Kepuasan Layanan UKS</h1>
     <p id="school-text" class="text-lg font-semibold mb-6 text-center" style="color: #1565c0;">MTs Negeri 9 Bantul</p><!-- Real-Time Satisfaction Panel -->
     <div id="satisfaction-panel" class="bg-gradient-to-br rounded-2xl shadow-lg p-6 mb-6 text-center" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(33, 150, 243, 0.1) 100%); border: 2px solid #e8f5e9;">
      <h3 class="text-sm font-semibold mb-3" style="color: #2e7d32;">ğŸ“Š Kepuasan Layanan UKS Saat Ini</h3>
      <div class="flex items-baseline justify-center gap-2 mb-3"><span id="satisfaction-score" class="text-5xl font-extrabold" style="color: #2e7d32;">0</span> <span class="text-2xl font-semibold text-gray-400">/100</span>
      </div>
      <p class="text-xs text-gray-600 mb-3">Nilai rata-rata kepuasan berdasarkan survei yang telah masuk.</p>
      <p id="satisfaction-status" class="text-sm font-semibold px-3 py-2 rounded-full inline-block" style="background: #fff3e0; color: #f57c00;">Dalam proses peningkatan layanan.</p>
     </div><!-- Respondent Breakdown Section -->
     <div class="bg-white rounded-2xl shadow-lg p-6 mt-6">
      <h3 class="text-sm font-semibold mb-3" style="color: #2e7d32;">ğŸ‘¥ Responden:</h3>
      <div id="respondent-breakdown" class="text-sm text-gray-700 space-y-2">
       <div class="flex justify-between items-center py-1"><span>Guru:</span> <span id="count-guru" class="font-semibold" style="color: #2e7d32;">0</span>
       </div>
       <div class="flex justify-between items-center py-1"><span>Pegawai:</span> <span id="count-pegawai" class="font-semibold" style="color: #2e7d32;">0</span>
       </div>
       <div class="flex justify-between items-center py-1"><span>Siswa Kelas VII:</span> <span id="count-siswa-vii" class="font-semibold" style="color: #2e7d32;">0</span>
       </div>
       <div class="flex justify-between items-center py-1"><span>Siswa Kelas VIII:</span> <span id="count-siswa-viii" class="font-semibold" style="color: #2e7d32;">0</span>
       </div>
       <div class="flex justify-between items-center py-1"><span>Siswa Kelas IX:</span> <span id="count-siswa-ix" class="font-semibold" style="color: #2e7d32;">0</span>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <p id="welcome-text" class="text-gray-600 leading-relaxed">Survei ini bertujuan untuk mengukur tingkat kepuasan Anda terhadap layanan Unit Kesehatan Sekolah (UKS). Masukan Anda sangat berharga untuk meningkatkan kualitas pelayanan kesehatan di madrasah kita.</p>
     </div><button onclick="showPage('respondent')" class="w-full py-4 px-8 rounded-xl font-bold text-lg text-white shadow-lg hover:shadow-xl transition-all duration-300" style="background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%);"> ğŸ¥ Mulai Survei </button>
    </div>
   </div><!-- Page 2: Respondent Info -->
   <div id="page-respondent" class="min-h-full flex flex-col items-center justify-center p-6 hidden">
    <div class="max-w-lg w-full fade-in">
     <div class="bg-white rounded-2xl shadow-lg p-6">
      <h2 class="text-xl font-bold mb-6 text-center" style="color: #2e7d32;">ğŸ“‹ Data Responden</h2>
      <div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-2">Nama Pengguna Layanan UKS <span class="text-gray-400 text-xs">(opsional)</span></label> <input type="text" id="respondent-name" placeholder="Masukkan nama Anda (opsional)" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-green-400 focus:outline-none transition-all">
       <p class="text-xs text-gray-500 mt-2">Isian ini bersifat opsional dan hanya digunakan untuk keperluan dokumentasi internal madrasah.</p>
      </div>
      <div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-3">Status Anda:</label>
       <div class="grid grid-cols-3 gap-3"><button type="button" onclick="selectRole('Siswa')" id="role-siswa" class="role-btn py-3 px-4 rounded-xl border-2 border-gray-200 font-semibold transition-all hover:border-green-400"> ğŸ‘¨â€ğŸ“ Siswa </button> <button type="button" onclick="selectRole('Guru')" id="role-guru" class="role-btn py-3 px-4 rounded-xl border-2 border-gray-200 font-semibold transition-all hover:border-green-400"> ğŸ‘¨â€ğŸ« Guru </button> <button type="button" onclick="selectRole('Pegawai')" id="role-pegawai" class="role-btn py-3 px-4 rounded-xl border-2 border-gray-200 font-semibold transition-all hover:border-green-400"> ğŸ‘” Pegawai </button>
       </div>
      </div>
      <div id="class-section" class="mb-6 hidden"><label class="block text-sm font-semibold text-gray-700 mb-3">Kelas:</label>
       <div class="grid grid-cols-3 gap-3"><button type="button" onclick="selectClass('VII')" id="class-vii" class="class-btn py-3 px-4 rounded-xl border-2 border-gray-200 font-semibold transition-all hover:border-blue-400"> VII </button> <button type="button" onclick="selectClass('VIII')" id="class-viii" class="class-btn py-3 px-4 rounded-xl border-2 border-gray-200 font-semibold transition-all hover:border-blue-400"> VIII </button> <button type="button" onclick="selectClass('IX')" id="class-ix" class="class-btn py-3 px-4 rounded-xl border-2 border-gray-200 font-semibold transition-all hover:border-blue-400"> IX </button>
       </div>
      </div>
      <div class="flex gap-3"><button onclick="showPage('home')" class="flex-1 py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50 transition-all"> â† Kembali </button> <button id="btn-next-survey" onclick="startSurvey()" disabled class="flex-1 py-3 px-6 rounded-xl font-semibold text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed" style="background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%);"> Lanjutkan â†’ </button>
      </div>
     </div>
    </div>
   </div><!-- Page 3: Survey Questions -->
   <div id="page-survey" class="min-h-full flex flex-col p-6 hidden">
    <div class="max-w-2xl w-full mx-auto fade-in"><!-- Progress Bar -->
     <div class="bg-white rounded-full h-3 mb-6 overflow-hidden shadow-inner">
      <div id="progress-bar" class="progress-bar h-full rounded-full" style="width: 0%; background: linear-gradient(90deg, #4CAF50 0%, #2196F3 100%);"></div>
     </div>
     <div class="bg-white rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-4"><span id="question-number" class="text-sm font-semibold px-3 py-1 rounded-full" style="background: #e8f5e9; color: #2e7d32;">Pertanyaan 1/5</span> <span class="text-sm text-gray-500">Pilih salah satu</span>
      </div>
      <h3 id="question-text" class="text-lg font-bold text-gray-800 mb-6"></h3>
      <div id="likert-options" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6"><!-- Options will be generated dynamically -->
      </div>
      <div class="flex gap-3"><button id="btn-prev" onclick="prevQuestion()" class="flex-1 py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50 transition-all"> â† Sebelumnya </button> <button id="btn-next" onclick="nextQuestion()" disabled class="flex-1 py-3 px-6 rounded-xl font-semibold text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed" style="background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%);"> Selanjutnya â†’ </button>
      </div>
     </div>
    </div>
   </div><!-- Page 4: Feedback & Suggestions -->
   <div id="page-feedback" class="min-h-full flex flex-col items-center justify-center p-6 hidden">
    <div class="max-w-2xl w-full mx-auto fade-in">
     <div class="bg-white rounded-2xl shadow-lg p-6">
      <h2 class="text-2xl font-bold mb-2 text-center" style="color: #2e7d32;">ğŸ’¬ Saran dan Masukan</h2>
      <p class="text-center text-gray-600 text-sm mb-6">Terima kasih telah mengisi survei. Kami menerima saran Anda untuk perbaikan layanan.</p>
      <div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-3">Tuliskan saran atau masukan Anda untuk peningkatan layanan UKS <span class="text-gray-400 text-xs">(opsional)</span></label> <textarea id="feedback-input" placeholder="Contoh: penambahan obat, kebersihan ruang UKS, waktu pelayanan, dan lain-lain." class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-green-400 focus:outline-none transition-all resize-none" rows="5"></textarea>
      </div>
      <div class="flex gap-3"><button onclick="prevFeedback()" class="flex-1 py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50 transition-all"> â† Sebelumnya </button> <button onclick="submitWithFeedback()" class="flex-1 py-3 px-6 rounded-xl font-semibold text-white transition-all" style="background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%);"> Selesai Survei â†’ </button>
      </div>
     </div>
    </div>
   </div><!-- Page 5: Results -->
   <div id="page-results" class="min-h-full flex flex-col items-center justify-center p-6 hidden">
    <div class="max-w-lg w-full fade-in">
     <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
      <div id="result-icon" class="mb-4"><!-- Icon will be set based on score -->
      </div>
      <h2 class="text-2xl font-bold mb-2" style="color: #2e7d32;">Hasil Survei Anda</h2>
      <div class="my-6">
       <div class="relative w-40 h-40 mx-auto">
        <svg class="w-full h-full" viewbox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="#e0e0e0" stroke-width="8" /> <circle id="score-circle" cx="50" cy="50" r="45" fill="none" stroke="#4CAF50" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" transform="rotate(-90 50 50)" style="transition: stroke-dashoffset 1s ease;" />
        </svg>
        <div class="absolute inset-0 flex flex-col items-center justify-center"><span id="score-value" class="text-4xl font-extrabold" style="color: #2e7d32;">0</span> <span class="text-sm text-gray-500">dari 100</span>
        </div>
       </div>
      </div>
      <div id="score-category" class="inline-block px-4 py-2 rounded-full font-bold text-lg mb-4"><!-- Category badge -->
      </div>
      <p id="score-description" class="text-gray-600 mb-6"></p>
      <div class="bg-blue-50 rounded-xl p-4 mb-6 border-l-4" style="border-color: #1565c0;">
       <p id="score-statement" class="text-sm font-semibold" style="color: #1565c0;"></p>
      </div>
      <div class="bg-gray-50 rounded-xl p-4 mb-6">
       <h4 class="font-semibold text-gray-700 mb-2">ğŸ“Š Rincian Skor:</h4>
       <div id="score-details" class="text-sm text-left space-y-1"><!-- Score details -->
       </div>
      </div>
      <div id="redirect-message" class="bg-green-50 rounded-xl p-3 mb-6 text-center border border-green-200 hidden">
       <p class="text-sm font-semibold text-green-700">âœ“ Terima kasih. Hasil kepuasan telah diperbarui secara otomatis.</p>
       <p class="text-xs text-green-600 mt-1">Anda akan diarahkan ke halaman utama dalam beberapa detik...</p>
      </div><button id="btn-close-results" onclick="showPage('closing')" class="w-full py-3 px-6 rounded-xl font-semibold text-white" style="background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%);"> Selesai âœ“ </button>
     </div>
    </div>
   </div><!-- Page 5: Closing -->
   <div id="page-closing" class="min-h-full flex flex-col items-center justify-center p-6 hidden">
    <div class="max-w-lg w-full text-center fade-in">
     <div class="mb-6">
      <svg class="w-24 h-24 mx-auto" viewbox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="45" fill="#4CAF50" opacity="0.2" /> <path d="M30 50L45 65L70 35" stroke="#4CAF50" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
     </div>
     <h2 class="text-2xl font-bold mb-4" style="color: #2e7d32;">Terima Kasih!</h2>
     <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <p id="thankyou-text" class="text-gray-600 leading-relaxed mb-4">Terima kasih telah berpartisipasi dalam survei kepuasan layanan UKS MTs Negeri 9 Bantul.</p>
      <p class="text-gray-600 leading-relaxed mb-4">Hasil survei ini akan digunakan sebagai bahan evaluasi dan perbaikan kualitas layanan UKS untuk kenyamanan seluruh warga madrasah.</p>
      <p class="text-gray-600 leading-relaxed">Saran dan masukan yang diberikan akan digunakan sebagai bahan evaluasi dan peningkatan kualitas layanan UKS MTs Negeri 9 Bantul.</p>
     </div>
     <div class="bg-blue-50 rounded-xl p-4 mb-6">
      <p class="text-sm" style="color: #1565c0;">ğŸ“‹ Data survei ini tercatat sebagai dokumentasi resmi untuk pelaporan SKP dan akreditasi sekolah.</p>
     </div><button onclick="resetSurvey()" class="w-full py-3 px-6 rounded-xl font-semibold border-2 transition-all hover:bg-gray-50" style="border-color: #4CAF50; color: #2e7d32;"> ğŸ”„ Isi Survei Baru </button>
    </div>
   </div><!-- Toast Notification -->
   <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg hidden transition-all duration-300"><span id="toast-message"></span>
   </div><!-- Loading Overlay -->
   <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl p-6 flex items-center gap-3">
     <svg class="animate-spin w-6 h-6" style="color: #4CAF50;" viewbox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" opacity="0.25" /> <path d="M12 2a10 10 0 0110 10" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
     </svg><span class="font-semibold text-gray-700">Menyimpan data...</span>
    </div>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      survey_title: 'Survei Kepuasan Layanan UKS',
      school_name: 'MTs Negeri 9 Bantul',
      welcome_message: 'Survei ini bertujuan untuk mengukur tingkat kepuasan Anda terhadap layanan Unit Kesehatan Sekolah (UKS). Masukan Anda sangat berharga untuk meningkatkan kualitas pelayanan kesehatan di madrasah kita.',
      thank_you_message: 'Terima kasih telah berpartisipasi dalam survei kepuasan layanan UKS MTs Negeri 9 Bantul.',
      primary_color: '#4CAF50',
      secondary_color: '#2196F3',
      background_color: '#e8f5e9',
      text_color: '#333333',
      accent_color: '#2e7d32'
    };

    // Survey questions
    const questions = [
      'Ruang UKS bersih dan nyaman digunakan',
      'Obat dan alat kesehatan tersedia saat dibutuhkan',
      'Pelayanan UKS diberikan dengan cepat',
      'Petugas UKS bersikap ramah dan membantu',
      'Layanan UKS bermanfaat bagi warga madrasah'
    ];

    const likertOptions = [
      { value: 1, label: 'Tidak Puas', emoji: 'ğŸ˜' },
      { value: 2, label: 'Kurang Puas', emoji: 'ğŸ˜' },
      { value: 3, label: 'Puas', emoji: 'ğŸ˜Š' },
      { value: 4, label: 'Sangat Puas', emoji: 'ğŸ˜„' }
    ];

    // State variables
    let currentQuestion = 0;
    let answers = [0, 0, 0, 0, 0];
    let selectedRole = '';
    let selectedClass = '';
    let respondentName = '';
    let feedbackText = '';
    let surveyRecords = [];

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          updateUI(config);
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => window.elementSdk.setConfig({ primary_color: value })
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => window.elementSdk.setConfig({ secondary_color: value })
            },
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => window.elementSdk.setConfig({ background_color: value })
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => window.elementSdk.setConfig({ text_color: value })
            },
            {
              get: () => config.accent_color || defaultConfig.accent_color,
              set: (value) => window.elementSdk.setConfig({ accent_color: value })
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || 'Nunito',
            set: (value) => window.elementSdk.setConfig({ font_family: value })
          },
          fontSizeable: {
            get: () => config.font_size || 16,
            set: (value) => window.elementSdk.setConfig({ font_size: value })
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ['survey_title', config.survey_title || defaultConfig.survey_title],
          ['school_name', config.school_name || defaultConfig.school_name],
          ['welcome_message', config.welcome_message || defaultConfig.welcome_message],
          ['thank_you_message', config.thank_you_message || defaultConfig.thank_you_message]
        ])
      });
    }

    // Initialize Data SDK
    const dataHandler = {
      onDataChanged(data) {
        surveyRecords = data;
        updateSatisfactionDisplay();
      }
    };

    if (window.dataSdk) {
      window.dataSdk.init(dataHandler);
    }

    // Update UI based on config
    function updateUI(config) {
      const titleEl = document.getElementById('title-text');
      const schoolEl = document.getElementById('school-text');
      const welcomeEl = document.getElementById('welcome-text');
      const thankyouEl = document.getElementById('thankyou-text');
      const appEl = document.getElementById('app');

      if (titleEl) titleEl.textContent = config.survey_title || defaultConfig.survey_title;
      if (schoolEl) schoolEl.textContent = config.school_name || defaultConfig.school_name;
      if (welcomeEl) welcomeEl.textContent = config.welcome_message || defaultConfig.welcome_message;
      if (thankyouEl) thankyouEl.textContent = config.thank_you_message || defaultConfig.thank_you_message;

      // Apply colors
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;
      const bgColor = config.background_color || defaultConfig.background_color;
      
      if (titleEl) titleEl.style.color = accentColor;
      if (appEl) appEl.style.background = `linear-gradient(135deg, ${bgColor} 0%, #e3f2fd 50%, #f1f8e9 100%)`;

      // Apply font
      const fontFamily = config.font_family || 'Nunito';
      const baseSize = config.font_size || 16;
      document.body.style.fontFamily = `${fontFamily}, sans-serif`;
      
      if (titleEl) titleEl.style.fontSize = `${baseSize * 1.75}px`;
      if (schoolEl) schoolEl.style.fontSize = `${baseSize * 1.125}px`;
    }

    // Page navigation
    function showPage(pageId) {
      const pages = ['page-home', 'page-respondent', 'page-survey', 'page-feedback', 'page-results', 'page-closing'];
      pages.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.add('hidden');
          el.classList.remove('fade-in');
        }
      });
      const targetPage = document.getElementById('page-' + pageId);
      if (targetPage) {
        targetPage.classList.remove('hidden');
        setTimeout(() => targetPage.classList.add('fade-in'), 10);
      }
    }

    // Role selection
    function selectRole(role) {
      selectedRole = role;
      document.querySelectorAll('.role-btn').forEach(btn => {
        btn.classList.remove('border-green-500', 'bg-green-50');
        btn.style.borderColor = '#e5e7eb';
        btn.style.backgroundColor = 'white';
      });
      const btnId = 'role-' + role.toLowerCase();
      const selectedBtn = document.getElementById(btnId);
      if (selectedBtn) {
        selectedBtn.style.borderColor = '#4CAF50';
        selectedBtn.style.backgroundColor = '#e8f5e9';
      }
      
      const classSection = document.getElementById('class-section');
      if (role === 'Siswa') {
        classSection.classList.remove('hidden');
        selectedClass = '';
        document.querySelectorAll('.class-btn').forEach(btn => {
          btn.style.borderColor = '#e5e7eb';
          btn.style.backgroundColor = 'white';
        });
        updateNextButton();
      } else {
        classSection.classList.add('hidden');
        selectedClass = '-';
        updateNextButton();
      }
    }

    // Class selection
    function selectClass(cls) {
      selectedClass = cls;
      document.querySelectorAll('.class-btn').forEach(btn => {
        btn.style.borderColor = '#e5e7eb';
        btn.style.backgroundColor = 'white';
      });
      const btnId = 'class-' + cls.toLowerCase();
      const selectedBtn = document.getElementById(btnId);
      if (selectedBtn) {
        selectedBtn.style.borderColor = '#2196F3';
        selectedBtn.style.backgroundColor = '#e3f2fd';
      }
      updateNextButton();
    }

    function updateNextButton() {
      const btn = document.getElementById('btn-next-survey');
      const canProceed = selectedRole && (selectedRole !== 'Siswa' || selectedClass);
      btn.disabled = !canProceed;
    }

    // Reset form inputs only (for privacy protection)
    // Does NOT affect aggregated survey data or real-time display
    function resetFormInputsOnly() {
      // Clear respondent name input
      const nameInput = document.getElementById('respondent-name');
      if (nameInput) nameInput.value = '';

      // Clear feedback textarea
      const feedbackInput = document.getElementById('feedback-input');
      if (feedbackInput) feedbackInput.value = '';

      // Reset role selection UI
      selectedRole = '';
      selectedClass = '';
      document.querySelectorAll('.role-btn').forEach(btn => {
        btn.style.borderColor = '#e5e7eb';
        btn.style.backgroundColor = 'white';
      });

      // Reset class selection UI
      document.querySelectorAll('.class-btn').forEach(btn => {
        btn.style.borderColor = '#e5e7eb';
        btn.style.backgroundColor = 'white';
      });

      // Hide class section
      const classSection = document.getElementById('class-section');
      if (classSection) classSection.classList.add('hidden');

      // Disable next button
      const btnNextSurvey = document.getElementById('btn-next-survey');
      if (btnNextSurvey) btnNextSurvey.disabled = true;

      // Reset current survey answers only (not stored data)
      answers = [0, 0, 0, 0, 0];

      // Reset respondent name and feedback variables (current session only)
      respondentName = '';
      feedbackText = '';
    }

    // Start survey
    function startSurvey() {
      resetFormInputsOnly();
      currentQuestion = 0;
      showPage('survey');
      renderQuestion();
    }

    // Render current question
    function renderQuestion() {
      const questionText = document.getElementById('question-text');
      const questionNumber = document.getElementById('question-number');
      const progressBar = document.getElementById('progress-bar');
      const optionsContainer = document.getElementById('likert-options');
      const btnPrev = document.getElementById('btn-prev');
      const btnNext = document.getElementById('btn-next');

      questionText.textContent = questions[currentQuestion];
      questionNumber.textContent = `Pertanyaan ${currentQuestion + 1}/5`;
      progressBar.style.width = `${((currentQuestion + 1) / 5) * 100}%`;

      // Render likert options
      optionsContainer.innerHTML = likertOptions.map(opt => `
        <button type="button" onclick="selectAnswer(${opt.value})" 
          class="likert-option p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2 ${answers[currentQuestion] === opt.value ? 'selected' : ''}"
          style="border-color: ${answers[currentQuestion] === opt.value ? '#4CAF50' : '#e5e7eb'}; background-color: ${answers[currentQuestion] === opt.value ? '#e8f5e9' : 'white'};">
          <span class="text-2xl">${opt.emoji}</span>
          <span class="text-xs font-semibold text-center" style="color: ${answers[currentQuestion] === opt.value ? '#2e7d32' : '#666'};">${opt.label}</span>
        </button>
      `).join('');

      btnPrev.style.display = currentQuestion === 0 ? 'none' : 'block';
      btnNext.textContent = currentQuestion === 4 ? 'Kirim Jawaban â†’' : 'Selanjutnya â†’';
      btnNext.disabled = answers[currentQuestion] === 0;
    }

    // Select answer
    function selectAnswer(value) {
      answers[currentQuestion] = value;
      renderQuestion();
    }

    // Navigation
    function prevQuestion() {
      if (currentQuestion > 0) {
        currentQuestion--;
        renderQuestion();
      }
    }

    async function nextQuestion() {
      if (currentQuestion < 4) {
        currentQuestion++;
        renderQuestion();
      } else {
        showPage('feedback');
      }
    }

    // Feedback functions
    function prevFeedback() {
      currentQuestion = 4;
      showPage('survey');
      renderQuestion();
    }

    async function submitWithFeedback() {
      feedbackText = document.getElementById('feedback-input').value;
      respondentName = document.getElementById('respondent-name').value;
      await submitSurvey();
    }

    // Submit survey
    async function submitSurvey() {
      const totalScore = answers.reduce((a, b) => a + b, 0);
      const maxScore = 20;
      const finalScore = Math.round((totalScore / maxScore) * 100);

      let category;
      if (finalScore >= 85) category = 'Sangat Puas';
      else if (finalScore >= 80) category = 'Puas (Target Tercapai)';
      else if (finalScore >= 70) category = 'Cukup';
      else category = 'Kurang';

      // Show loading
      document.getElementById('loading-overlay').classList.remove('hidden');

      // Save to Data SDK
      if (window.dataSdk) {
        if (surveyRecords.length >= 999) {
          document.getElementById('loading-overlay').classList.add('hidden');
          showToast('Batas maksimum 999 data tercapai. Hapus beberapa data terlebih dahulu.');
          return;
        }

        const result = await window.dataSdk.create({
          respondent_name: respondentName,
          respondent_role: selectedRole,
          respondent_class: selectedClass,
          q1_score: answers[0],
          q2_score: answers[1],
          q3_score: answers[2],
          q4_score: answers[3],
          q5_score: answers[4],
          total_score: totalScore,
          final_score: finalScore,
          category: category,
          feedback: feedbackText,
          submitted_at: new Date().toISOString()
        });

        document.getElementById('loading-overlay').classList.add('hidden');

        if (!result.isOk) {
          showToast('Gagal menyimpan data. Silakan coba lagi.');
          return;
        }
      } else {
        document.getElementById('loading-overlay').classList.add('hidden');
      }

      // Show results
      showResults(totalScore, finalScore, category);
    }

    // Show results
    function showResults(totalScore, finalScore, category) {
      showPage('results');

      // Animate score circle
      const scoreCircle = document.getElementById('score-circle');
      const circumference = 2 * Math.PI * 45;
      const offset = circumference - (finalScore / 100) * circumference;
      setTimeout(() => {
        scoreCircle.style.strokeDashoffset = offset;
      }, 100);

      // Animate score value
      const scoreValue = document.getElementById('score-value');
      let current = 0;
      const increment = finalScore / 50;
      const timer = setInterval(() => {
        current += increment;
        if (current >= finalScore) {
          current = finalScore;
          clearInterval(timer);
        }
        scoreValue.textContent = Math.round(current);
      }, 20);

      // Set category badge
      const categoryEl = document.getElementById('score-category');
      let badgeColor, badgeBg;
      if (finalScore >= 85) {
        badgeColor = '#2e7d32'; badgeBg = '#e8f5e9';
      } else if (finalScore >= 80) {
        badgeColor = '#1565c0'; badgeBg = '#e3f2fd';
      } else if (finalScore >= 70) {
        badgeColor = '#f57c00'; badgeBg = '#fff3e0';
      } else {
        badgeColor = '#c62828'; badgeBg = '#ffebee';
      }
      categoryEl.style.color = badgeColor;
      categoryEl.style.backgroundColor = badgeBg;
      categoryEl.textContent = category;

      // Set result icon
      const iconEl = document.getElementById('result-icon');
      let iconEmoji = finalScore >= 80 ? 'ğŸ‰' : finalScore >= 70 ? 'ğŸ‘' : 'ğŸ“ˆ';
      iconEl.innerHTML = `<span class="text-6xl">${iconEmoji}</span>`;

      // Set description
      const descEl = document.getElementById('score-description');
      if (finalScore >= 85) {
        descEl.textContent = 'Luar biasa! Anda sangat puas dengan layanan UKS.';
      } else if (finalScore >= 80) {
        descEl.textContent = 'Bagus! Target kepuasan tercapai. Terima kasih atas penilaian positif Anda.';
      } else if (finalScore >= 70) {
        descEl.textContent = 'Cukup baik. Ada beberapa aspek yang perlu ditingkatkan.';
      } else {
        descEl.textContent = 'Terima kasih atas masukan Anda. Kami akan berupaya meningkatkan layanan.';
      }

      // Set score statement
      const statementEl = document.getElementById('score-statement');
      let statement = `Nilai kepuasan layanan UKS adalah ${finalScore} dan termasuk kategori ${category}.`;
      if (finalScore >= 80) {
        statement += ' Target minimal kepuasan (80) telah tercapai.';
      }
      statementEl.textContent = statement;

      // Score details
      const detailsEl = document.getElementById('score-details');
      detailsEl.innerHTML = questions.map((q, i) => `
        <div class="flex justify-between items-center py-1 border-b border-gray-100">
          <span class="text-gray-600 truncate pr-2" style="max-width: 70%;">${q}</span>
          <span class="font-semibold" style="color: ${getScoreColor(answers[i])};">${answers[i]}/4</span>
        </div>
      `).join('') + `
        <div class="flex justify-between items-center pt-2 font-bold">
          <span>Total Skor</span>
          <span style="color: #2e7d32;">${totalScore}/20</span>
        </div>
      `;

      // Show redirect message and auto-redirect
      const redirectMsg = document.getElementById('redirect-message');
      const closeBtn = document.getElementById('btn-close-results');
      if (redirectMsg) {
        redirectMsg.classList.remove('hidden');
      }
      if (closeBtn) {
        closeBtn.disabled = true;
        closeBtn.style.opacity = '0.5';
        closeBtn.style.cursor = 'not-allowed';
      }

      // Auto-redirect to home after 4 seconds
      setTimeout(() => {
        showPage('home');
        if (closeBtn) {
          closeBtn.disabled = false;
          closeBtn.style.opacity = '1';
          closeBtn.style.cursor = 'pointer';
        }
        if (redirectMsg) {
          redirectMsg.classList.add('hidden');
        }
      }, 4000);
    }

    function getScoreColor(score) {
      if (score === 4) return '#2e7d32';
      if (score === 3) return '#1565c0';
      if (score === 2) return '#f57c00';
      return '#c62828';
    }

    // Reset survey
    function resetSurvey() {
      resetFormInputsOnly();
      currentQuestion = 0;
      showPage('home');
    }

    // Update satisfaction display
    function updateSatisfactionDisplay() {
      if (!surveyRecords || surveyRecords.length === 0) {
        displaySatisfactionScore(0);
        updateRespondentBreakdown([]);
        return;
      }

      const totalScore = surveyRecords.reduce((sum, record) => {
        return sum + (record.final_score || 0);
      }, 0);

      const averageScore = Math.round(totalScore / surveyRecords.length);
      displaySatisfactionScore(averageScore);
      updateRespondentBreakdown(surveyRecords);
    }

    // Update respondent breakdown display from stored survey records
    function updateRespondentBreakdown(records) {
      // Initialize counts - these are directly calculated from stored data
      let countGuru = 0;
      let countPegawai = 0;
      let countSiswaVII = 0;
      let countSiswaVIII = 0;
      let countSiswaIX = 0;

      // Count respondents from stored survey records
      if (records && records.length > 0) {
        records.forEach(record => {
          const role = record.respondent_role;
          const classLevel = record.respondent_class;

          // Count by role
          if (role === 'Guru') {
            countGuru++;
          } else if (role === 'Pegawai') {
            countPegawai++;
          } else if (role === 'Siswa') {
            // Count by class for students
            if (classLevel === 'VII') {
              countSiswaVII++;
            } else if (classLevel === 'VIII') {
              countSiswaVIII++;
            } else if (classLevel === 'IX') {
              countSiswaIX++;
            }
          }
        });
      }

      // Update DOM elements with exact counts from stored data
      const guruEl = document.getElementById('count-guru');
      const pegawaiEl = document.getElementById('count-pegawai');
      const siswaVIIEl = document.getElementById('count-siswa-vii');
      const siswaVIIIEl = document.getElementById('count-siswa-viii');
      const siswaIXEl = document.getElementById('count-siswa-ix');

      if (guruEl) guruEl.textContent = countGuru;
      if (pegawaiEl) pegawaiEl.textContent = countPegawai;
      if (siswaVIIEl) siswaVIIEl.textContent = countSiswaVII;
      if (siswaVIIIEl) siswaVIIIEl.textContent = countSiswaVIII;
      if (siswaIXEl) siswaIXEl.textContent = countSiswaIX;
    }

    // Display satisfaction score with animation
    function displaySatisfactionScore(score) {
      const scoreEl = document.getElementById('satisfaction-score');
      const statusEl = document.getElementById('satisfaction-status');

      if (!scoreEl || !statusEl) return;

      // Animate the score count-up
      let current = 0;
      const increment = score / 40;
      const timer = setInterval(() => {
        current += increment;
        if (current >= score) {
          current = score;
          clearInterval(timer);
        }
        scoreEl.textContent = Math.round(current);
      }, 15);

      // Update status message
      if (score >= 80) {
        statusEl.style.background = '#e8f5e9';
        statusEl.style.color = '#2e7d32';
        statusEl.textContent = 'âœ“ Target minimal kepuasan (80) telah tercapai.';
      } else {
        statusEl.style.background = '#fff3e0';
        statusEl.style.color = '#f57c00';
        statusEl.textContent = 'Dalam proses peningkatan layanan.';
      }
    }

    // Toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      toastMessage.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }

    // Initialize
    updateUI(defaultConfig);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c7673f9a762dfe3',t:'MTc3MDAwMTM4MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
